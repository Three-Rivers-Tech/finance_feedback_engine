{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/yourusername/finance_feedback_engine/config.schema.json",
  "title": "Finance Feedback Engine 2.0 Configuration",
  "description": "Schema for validating Finance Feedback Engine configuration files",
  "type": "object",
  "required": ["decision_engine", "persistence"],
  "properties": {
    "alpha_vantage_api_key": {
      "type": "string",
      "description": "Alpha Vantage API key for market data",
      "pattern": "^(\\$\\{[^}]+\\}|demo|YOUR_ALPHA_VANTAGE_API_KEY)$",
      "examples": ["${ALPHA_VANTAGE_API_KEY}", "demo"]
    },
    "trading_platform": {
      "type": "string",
      "description": "Trading platform to use",
      "enum": ["coinbase", "coinbase_advanced", "oanda", "mock", "unified"]
    },
    "platform_credentials": {
      "type": "object",
      "description": "Platform-specific credentials",
      "properties": {
        "api_key": {
          "type": "string",
          "pattern": "^(\\$\\{[^}]+\\}|YOUR_[A-Z_]+)$"
        },
        "api_secret": {
          "type": "string",
          "pattern": "^(\\$\\{[^}]+\\}|YOUR_[A-Z_]+|-----BEGIN.*KEY-----)$"
        },
        "account_id": {
          "type": "string",
          "pattern": "^(\\$\\{[^}]+\\}|YOUR_[A-Z_]+|[0-9\\-]+)$"
        },
        "use_sandbox": {
          "type": "boolean",
          "description": "Whether to use sandbox/test environment"
        },
        "environment": {
          "type": "string",
          "enum": ["practice", "live"],
          "description": "Trading environment (Oanda)"
        }
      }
    },
    "platforms": {
      "type": "array",
      "description": "Multi-platform configuration for unified mode",
      "items": {
        "type": "object",
        "required": ["name", "credentials"],
        "properties": {
          "name": {
            "type": "string",
            "enum": ["coinbase", "coinbase_advanced", "oanda"]
          },
          "credentials": {
            "type": "object",
            "properties": {
              "api_key": {"type": "string"},
              "api_secret": {"type": "string"},
              "account_id": {"type": "string"},
              "use_sandbox": {"type": "boolean"},
              "environment": {
                "type": "string",
                "enum": ["practice", "live"]
              }
            }
          }
        }
      }
    },
    "providers": {
      "type": "object",
      "description": "Data provider credentials",
      "properties": {
        "alpha_vantage": {
          "type": "object",
          "properties": {
            "api_key": {"type": "string"}
          }
        },
        "coinbase": {
          "type": "object",
          "properties": {
            "credentials": {"type": "object"}
          }
        },
        "oanda": {
          "type": "object",
          "properties": {
            "credentials": {"type": "object"}
          }
        }
      }
    },
    "decision_engine": {
      "type": "object",
      "description": "AI decision engine configuration",
      "required": ["ai_provider"],
      "properties": {
        "ai_provider": {
          "type": "string",
          "description": "AI provider to use",
          "enum": ["local", "cli", "codex", "qwen", "gemini", "ensemble", "mock"]
        },
        "model_name": {
          "type": "string",
          "description": "Model name or identifier",
          "examples": ["llama3.2:3b-instruct-fp16", "deepseek-r1:8b", "gemini-pro"]
        },
        "local_models": {
          "type": "array",
          "description": "List of local models available for ensemble",
          "items": {"type": "string"}
        },
        "local_priority": {
          "description": "Priority boost for local providers in ensemble",
          "oneOf": [
            {"type": "boolean"},
            {"type": "string", "enum": ["soft"]},
            {"type": "number", "minimum": 1.0, "maximum": 5.0}
          ]
        },
        "decision_threshold": {
          "type": "number",
          "description": "Minimum confidence threshold for decisions",
          "minimum": 0.0,
          "maximum": 1.0,
          "default": 0.7
        },
        "prompt_template": {
          "type": "string",
          "description": "Path to custom prompt template file"
        },
        "debug": {
          "type": "boolean",
          "description": "Enable debug mode (development only)",
          "default": false
        },
        "gemini": {
          "type": "object",
          "properties": {
            "api_key": {"type": "string"},
            "model_name": {"type": "string"}
          }
        }
      }
    },
    "ensemble": {
      "type": "object",
      "description": "Ensemble AI provider configuration",
      "properties": {
        "enabled_providers": {
          "type": "array",
          "description": "List of providers to include in ensemble",
          "items": {"type": "string"},
          "minItems": 1
        },
        "provider_weights": {
          "type": "object",
          "description": "Weights for each provider (must sum to 1.0)",
          "patternProperties": {
            ".*": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0
            }
          }
        },
        "voting_strategy": {
          "type": "string",
          "description": "Strategy for aggregating provider votes",
          "enum": ["weighted", "majority", "stacking"],
          "default": "weighted"
        },
        "debate_mode": {
          "type": "boolean",
          "description": "Enable structured debate between providers",
          "default": true
        },
        "debate_providers": {
          "type": "object",
          "description": "Providers for debate roles",
          "properties": {
            "bull": {"type": "string"},
            "bear": {"type": "string"},
            "judge": {"type": "string"}
          }
        },
        "agreement_threshold": {
          "type": "number",
          "description": "Minimum agreement threshold for consensus",
          "minimum": 0.0,
          "maximum": 1.0,
          "default": 0.6
        },
        "adaptive_learning": {
          "type": "boolean",
          "description": "Enable adaptive weight adjustment",
          "default": true
        },
        "learning_rate": {
          "type": "number",
          "description": "Learning rate for weight updates",
          "minimum": 0.0,
          "maximum": 1.0,
          "default": 0.1
        },
        "two_phase": {
          "type": "object",
          "description": "Two-phase ensemble configuration",
          "properties": {
            "enabled": {"type": "boolean", "default": false},
            "phase1_min_quorum": {
              "type": "integer",
              "minimum": 1,
              "maximum": 10,
              "default": 3
            },
            "phase1_confidence_threshold": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0,
              "default": 0.75
            },
            "phase1_agreement_threshold": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0,
              "default": 0.6
            },
            "require_premium_for_high_stakes": {"type": "boolean"},
            "high_stakes_position_threshold": {
              "type": "number",
              "minimum": 0
            },
            "asset_routing": {
              "type": "object",
              "properties": {
                "crypto": {"type": "string"},
                "forex": {"type": "string"},
                "stock": {"type": "string"},
                "fallback": {"type": "string"},
                "codex_as_tiebreaker": {"type": "boolean"},
                "max_premium_calls_per_day": {
                  "type": "integer",
                  "minimum": 0
                }
              }
            }
          }
        }
      }
    },
    "monitoring": {
      "type": "object",
      "description": "Live trading monitoring configuration",
      "properties": {
        "enable_context_integration": {
          "type": "boolean",
          "description": "Enable AI position awareness",
          "default": true
        },
        "enabled": {
          "type": "boolean",
          "description": "Auto-start TradeMonitor",
          "default": false
        },
        "manual_cli": {
          "type": "boolean",
          "description": "Allow manual CLI monitor commands",
          "default": false
        },
        "pulse_interval_seconds": {
          "type": "integer",
          "description": "Pulse interval for cached analysis",
          "minimum": 30,
          "maximum": 3600,
          "default": 300
        },
        "include_sentiment": {
          "type": "boolean",
          "description": "Include sentiment data in analysis",
          "default": true
        },
        "include_macro": {
          "type": "boolean",
          "description": "Include macro indicators in analysis",
          "default": false
        },
        "enable_live_view": {
          "type": "boolean",
          "default": false
        },
        "live_view": {
          "type": "object",
          "properties": {
            "refresh_rates": {
              "type": "object",
              "properties": {
                "fast": {"type": "integer", "minimum": 1},
                "medium": {"type": "integer", "minimum": 1},
                "slow": {"type": "integer", "minimum": 1},
                "lazy": {"type": "integer", "minimum": 1}
              }
            },
            "panels": {
              "type": "object",
              "patternProperties": {
                ".*": {"type": "boolean"}
              }
            }
          }
        }
      }
    },
    "persistence": {
      "type": "object",
      "description": "Persistence and storage configuration",
      "required": ["storage_path"],
      "properties": {
        "storage_path": {
          "type": "string",
          "description": "Path to store trading decisions",
          "pattern": "^[^/].*$",
          "default": "data/decisions"
        },
        "max_decisions": {
          "type": "integer",
          "description": "Maximum decisions to keep in memory",
          "minimum": 100,
          "maximum": 100000,
          "default": 1000
        },
        "cleanup_days": {
          "type": "integer",
          "description": "Auto-cleanup old decisions (days)",
          "minimum": 1,
          "maximum": 365,
          "default": 30
        }
      }
    },
    "portfolio_memory": {
      "type": "object",
      "description": "Portfolio memory engine configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "max_memory_size": {
          "type": "integer",
          "minimum": 100,
          "maximum": 100000,
          "default": 1000
        },
        "learning_rate": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "default": 0.1
        },
        "context_window": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100,
          "default": 20
        }
      }
    },
    "telegram": {
      "type": "object",
      "description": "Telegram notifications configuration",
      "properties": {
        "enabled": {"type": "boolean", "default": false},
        "bot_token": {
          "oneOf": [
            {"type": "null"},
            {"type": "string", "pattern": "^(\\$\\{[^}]+\\}|[0-9]+:[A-Za-z0-9_-]+)$"}
          ]
        },
        "chat_id": {
          "oneOf": [
            {"type": "null"},
            {"type": "integer"},
            {"type": "string"}
          ]
        },
        "ngrok_auth_token": {
          "type": "string"
        },
        "allowed_user_ids": {
          "type": "array",
          "items": {"type": "integer"}
        }
      }
    },
    "backtesting": {
      "type": "object",
      "description": "Backtesting configuration",
      "properties": {
        "enabled": {"type": "boolean", "default": false},
        "use_real_data": {"type": "boolean", "default": false},
        "initial_balance": {
          "type": "number",
          "minimum": 100,
          "default": 10000
        },
        "fee_percentage": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 10.0,
          "default": 0.1
        },
        "strategy": {
          "type": "object",
          "properties": {
            "name": {"type": "string"},
            "short_window": {"type": "integer", "minimum": 1},
            "long_window": {"type": "integer", "minimum": 1}
          }
        },
        "rl": {
          "type": "object",
          "properties": {
            "learning_rate": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0
            },
            "discount_factor": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0
            },
            "exploration_rate": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0
            }
          }
        }
      }
    },
    "advanced_backtesting": {
      "type": "object",
      "description": "Advanced backtesting settings",
      "properties": {
        "initial_balance": {"type": "number", "minimum": 0},
        "fee_percentage": {"type": "number", "minimum": 0},
        "slippage_percentage": {"type": "number", "minimum": 0},
        "slippage_impact_factor": {"type": "number", "minimum": 0},
        "commission_per_trade": {"type": "number", "minimum": 0},
        "stop_loss_percentage": {"type": "number", "minimum": 0, "maximum": 1},
        "take_profit_percentage": {"type": "number", "minimum": 0},
        "default_timeframe": {
          "type": "string",
          "enum": ["1min", "5min", "15min", "1h", "4h", "daily"]
        },
        "rapid_test_timeframe": {
          "type": "string",
          "enum": ["1h", "4h", "daily"]
        },
        "enable_risk_gatekeeper": {"type": "boolean"},
        "enable_multi_timeframe_pulse": {"type": "boolean"},
        "enable_decision_cache": {"type": "boolean"},
        "enable_portfolio_memory": {"type": "boolean"},
        "memory_isolation_mode": {"type": "boolean"},
        "force_local_providers": {"type": "boolean"},
        "max_concurrent_positions": {"type": "integer", "minimum": 1}
      }
    },
    "safety": {
      "type": "object",
      "description": "Safety and execution controls",
      "properties": {
        "max_leverage": {
          "type": "number",
          "minimum": 1.0,
          "maximum": 100.0,
          "default": 5.0
        },
        "max_position_pct": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 100.0,
          "default": 25.0
        }
      }
    },
    "circuit_breaker": {
      "type": "object",
      "description": "Circuit breaker configuration",
      "properties": {
        "failure_threshold": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "default": 3
        },
        "recovery_timeout_seconds": {
          "type": "integer",
          "minimum": 10,
          "maximum": 3600,
          "default": 300
        },
        "half_open_retry": {
          "type": "integer",
          "minimum": 1,
          "maximum": 5,
          "default": 1
        }
      }
    },
    "logging": {
      "type": "object",
      "description": "Logging configuration",
      "properties": {
        "level": {
          "type": "string",
          "enum": ["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"],
          "default": "INFO"
        },
        "file": {
          "type": "string",
          "description": "Optional log file path"
        }
      }
    },
    "agent": {
      "type": "object",
      "description": "Trading agent configuration",
      "properties": {
        "autonomous_execution": {"type": "boolean", "default": false},
        "approval_policy": {
          "type": "string",
          "enum": ["always", "never", "on_new_asset"],
          "default": "on_new_asset"
        },
        "max_daily_trades": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100,
          "default": 5
        },
        "strategic_goal": {
          "type": "string",
          "enum": ["balanced", "aggressive", "conservative"]
        },
        "risk_appetite": {
          "type": "string",
          "enum": ["low", "medium", "high"]
        },
        "autonomous": {
          "type": "object",
          "properties": {
            "enabled": {"type": "boolean"},
            "profit_target": {"type": "number", "minimum": 0},
            "stop_loss": {"type": "number", "minimum": 0, "maximum": 1}
          }
        },
        "correlation_threshold": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "default": 0.7
        },
        "max_correlated_assets": {
          "type": "integer",
          "minimum": 1,
          "default": 2
        },
        "max_var_pct": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "default": 0.05
        },
        "var_confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "default": 0.95
        }
      }
    },
    "benchmark": {
      "type": "object",
      "properties": {
        "asset_pairs": {
          "type": "array",
          "items": {"type": "string"}
        },
        "start_date": {
          "type": "string",
          "format": "date"
        },
        "end_date": {
          "type": "string",
          "format": "date"
        },
        "benchmark_frequency": {"type": "integer", "minimum": 1},
        "save_reports": {"type": "boolean"},
        "reports_directory": {"type": "string"}
      }
    },
    "refactoring": {
      "type": "object",
      "properties": {
        "max_concurrent": {"type": "integer", "minimum": 1},
        "degradation_threshold": {"type": "number", "maximum": 0},
        "benchmark_frequency": {"type": "integer", "minimum": 1},
        "use_git": {"type": "boolean"},
        "auto_rollback": {"type": "boolean"},
        "output_directory": {"type": "string"}
      }
    },
    "optimization": {
      "type": "object",
      "properties": {
        "n_trials": {"type": "integer", "minimum": 1},
        "optimize_for": {
          "type": "string",
          "enum": ["sharpe_ratio", "total_return", "profit_factor", "win_rate"]
        },
        "timeout": {
          "oneOf": [
            {"type": "null"},
            {"type": "integer", "minimum": 1}
          ]
        },
        "save_results": {"type": "boolean"},
        "results_directory": {"type": "string"},
        "search_spaces": {"type": "object"}
      }
    },
    "api_auth": {
      "type": "object",
      "description": "API authentication configuration",
      "properties": {
        "rate_limit_max": {
          "type": "integer",
          "minimum": 1,
          "default": 100
        },
        "rate_limit_window": {
          "type": "integer",
          "minimum": 1,
          "default": 60
        },
        "enable_fallback_to_config": {
          "type": "boolean",
          "default": true
        }
      }
    },
    "api_keys": {
      "type": "object",
      "description": "API keys (should be empty in base config)",
      "patternProperties": {
        ".*": {"type": "string"}
      }
    }
  },
  "additionalProperties": false
}
