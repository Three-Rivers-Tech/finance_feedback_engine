# Prometheus Alert Rules for Finance Feedback Engine

groups:
  - name: trading_agent_alerts
    interval: 30s
    rules:
      # Agent is down
      - alert: TradingAgentDown
        expr: up{job="ffe-app"} == 0
        for: 2m
        labels:
          severity: critical
          component: agent
        annotations:
          summary: "Trading agent is down"
          description: "The Finance Feedback Engine app has been down for more than 2 minutes."

      # High decision latency
      - alert: HighDecisionLatency
        expr: histogram_quantile(0.95, sum by (le) (rate(ffe_decision_latency_seconds_bucket[5m]))) > 10
        for: 5m
        labels:
          severity: warning
          component: decision_engine
        annotations:
          summary: "High decision latency detected"
          description: "95th percentile decision latency is {{ $value }}s (threshold: 10s)"

      # Provider failures
      - alert: HighProviderFailureRate
        expr: |
          sum(rate(ffe_provider_requests_total{status="failure"}[5m])) by (provider)
            /
          sum(rate(ffe_provider_requests_total[5m])) by (provider)
            > 0.1
        for: 5m
        labels:
          severity: warning
          component: ai_provider
        annotations:
          summary: "High provider failure rate"
          description: "Provider {{ $labels.provider }} has {{ $value | humanizePercentage }} failure rate"

      # Circuit breaker open
      - alert: CircuitBreakerOpen
        expr: ffe_circuit_breaker_state{service!=""} == 1
        for: 1m
        labels:
          severity: warning
          component: circuit_breaker
        annotations:
          summary: "Circuit breaker open for {{ $labels.service }}"
          description: "Circuit breaker for {{ $labels.service }} has been open for 1+ minutes"

  - name: portfolio_alerts
    interval: 30s
    rules:
      # Large drawdown
      - alert: LargeDrawdown
        expr: |
          (
            ffe_portfolio_value_dollars
              - (ffe_portfolio_value_dollars offset 1h)
          )
            /
          (ffe_portfolio_value_dollars offset 1h)
            < -0.05
        for: 5m
        labels:
          severity: critical
          component: risk_management
        annotations:
          summary: "Large portfolio drawdown detected"
          description: "Portfolio value dropped by {{ $value | humanizePercentage }} in the last hour"

      # High number of active trades
      - alert: TooManyActiveTrades
        expr: ffe_active_trades_total > 5
        for: 10m
        labels:
          severity: warning
          component: risk_management
        annotations:
          summary: "High number of active trades"
          description: "{{ $value }} active trades (threshold: 5). Possible runaway trading?"

      # No trades for extended period
      - alert: NoTradingActivity
        expr: rate(ffe_provider_requests_total[1h]) == 0
        for: 4h
        labels:
          severity: info
          component: monitoring
        annotations:
          summary: "No trading activity detected"
          description: "No AI provider requests in the last 4 hours. Agent may be stuck or disabled."

  - name: system_alerts
    interval: 30s
    rules:
      # High memory usage
      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.9
        for: 10m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High memory usage"
          description: "Memory usage is above 90% ({{ $value | humanizePercentage }})"

      # High CPU usage
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 10m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is above 80% ({{ $value }}%)"

      # Disk space running low
      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.1
        for: 5m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Disk space running low"
          description: "Less than 10% disk space remaining ({{ $value | humanizePercentage }} free)"

  - name: performance_alerts
    interval: 30s
    rules:
      # Low confidence decisions
      - alert: LowConfidenceDecisions
        expr: avg_over_time(ffe_decision_confidence[10m]) < 60
        for: 30m
        labels:
          severity: info
          component: decision_quality
        annotations:
          summary: "Low average decision confidence"
          description: "Average decision confidence is {{ $value }}% (threshold: 60%)"

      # Negative P&L trend
      - alert: NegativePnLTrend
        expr: sum(rate(ffe_trade_pnl_dollars_summary_sum[1h])) < 0
        for: 4h
        labels:
          severity: warning
          component: trading_performance
        annotations:
          summary: "Negative P&L trend detected"
          description: "Cumulative P&L has been negative for 4+ hours"
  - name: error_and_risk_alerts
    interval: 30s
    rules:
      # Risk blocks too frequent
      - alert: RiskGatekeeperBlockedTrades
        expr: increase(ffe_risk_blocks_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
          component: risk_management
        annotations:
          summary: "Risk gatekeeper blocking trades frequently"
          description: "{{ $value }} trades blocked in last 5m due to risk constraints"

      # Provider error rate high
      - alert: HighProviderErrorRate
        expr: |
          sum(rate(ffe_ensemble_provider_failures_total[5m]))
            /
          sum(rate(ffe_ensemble_provider_requests_total[5m]))
            > 0.2
        for: 5m
        labels:
          severity: critical
          component: ai_provider
        annotations:
          summary: "Provider error rate exceeds 20%"
          description: "Provider error rate is {{ $value | humanizePercentage }} (threshold: 20%)"

      # Decision execution gap
      - alert: DecisionExecutionGap
        expr: |
          (rate(ffe_decisions_created_total[5m]) - rate(ffe_decisions_executed_total[5m]))
            /
          rate(ffe_decisions_created_total[5m])
            > 0.1
        for: 10m
        labels:
          severity: warning
          component: execution
        annotations:
          summary: "Decision execution rate lagging creation"
          description: "{{ $value | humanizePercentage }} of decisions not executed within expected time"

      # API error threshold
      - alert: APIResponseErrors
        expr: sum(rate(ffe_api_response_errors_total[5m])) > 0.05
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "High API error rate"
          description: "API error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

  - name: pnl_and_performance_alerts
    interval: 30s
    rules:
      # Unrealized loss threshold
      - alert: UnrealizedLossThreshold
        expr: ffe_unrealized_pnl_dollars < (ffe_portfolio_value_usd * -0.1)
        for: 10m
        labels:
          severity: critical
          component: risk_management
        annotations:
          summary: "Unrealized loss exceeds 10% of portfolio"
          description: "Unrealized P&L: ${{ $value }} (portfolio: ${{ with query \"ffe_portfolio_value_usd\" | first | value }})"

      # Win rate collapse
      - alert: WinRateCollapse
        expr: |
          sum(increase(ffe_trades_won[1h]))
            /
          sum(increase(ffe_trades_executed_total[1h]))
            < 0.3
        for: 2h
        labels:
          severity: warning
          component: trading_performance
        annotations:
          summary: "Win rate below 30%"
          description: "Win rate is {{ $value | humanizePercentage }} (1-hour window, threshold: 30%)"

      # Unrealized loss per position
      - alert: LargeUnrealizedLossPerPosition
        expr: ffe_unrealized_pnl_dollars_per_position < -500
        for: 10m
        labels:
          severity: warning
          component: risk_management
        annotations:
          summary: "Single position unrealized loss exceeds $500"
          description: "Position {{ $labels.asset_pair }} unrealized loss: ${{ $value }}"

  - name: agent_state_alerts
    interval: 30s
    rules:
      # Agent state stuck
      - alert: AgentStateUnchanged
        expr: (time() - ffe_agent_last_state_change_seconds) > 300
        for: 5m
        labels:
          severity: warning
          component: agent
        annotations:
          summary: "Agent state unchanged for 5+ minutes"
          description: "Agent stuck in state: {{ $labels.agent_state }} for {{ $value | humanizeDuration }}"

      # High active position count
      - alert: HighActivePositionCount
        expr: ffe_active_positions > 10
        for: 5m
        labels:
          severity: warning
          component: risk_management
        annotations:
          summary: "Excessive number of open positions"
          description: "{{ $value }} active positions (threshold: 10). Check for diversification risk."

      # Decision-execution ratio anomaly
      - alert: DecisionCreationAnomaly
        expr: rate(ffe_decisions_created_total[5m]) > 2
        for: 5m
        labels:
          severity: info
          component: monitoring
        annotations:
          summary: "High decision creation rate"
          description: "Creating {{ $value }} decisions/sec (potential runaway)"

  - name: data_quality_alerts
    interval: 30s
    rules:
      # Stale market data
      - alert: StaleMarketData
        expr: (time() - ffe_market_data_last_updated_seconds) > 300
        for: 5m
        labels:
          severity: warning
          component: data_quality
        annotations:
          summary: "Market data is stale (>5 minutes)"
          description: "Last data update: {{ $value | humanizeDuration }} ago"

      # High provider latency
      - alert: HighProviderLatencyP95
        expr: histogram_quantile(0.95, sum(rate(ffe_ensemble_provider_latency_seconds_bucket[5m])) by (le, provider)) > 5
        for: 5m
        labels:
          severity: warning
          component: ai_provider
        annotations:
          summary: "Provider latency high (p95 > 5s)"
          description: "Provider {{ $labels.provider }} p95 latency: {{ $value }}s"

      # Data gaps
      - alert: MarketDataGapDetected
        expr: increase(ffe_market_data_gaps_total[5m]) > 0
        for: 5m
        labels:
          severity: warning
          component: data_quality
        annotations:
          summary: "Market data gaps detected"
          description: "{{ $value }} data gaps in last 5 minutes"

  - name: risk_threshold_alerts
    interval: 30s
    rules:
      # VaR limit approaching
      - alert: VaRLimitApproach
        expr: (ffe_var_utilization_ratio) > 0.8
        for: 10m
        labels:
          severity: warning
          component: risk_management
        annotations:
          summary: "VaR utilization approaching limit (>80%)"
          description: "VaR utilization: {{ $value | humanizePercentage }} (threshold: 80%)"

      # Portfolio concentration high
      - alert: HighPortfolioConcentration
        expr: max(ffe_asset_concentration_ratio) > 0.3
        for: 5m
        labels:
          severity: warning
          component: risk_management
        annotations:
          summary: "Portfolio concentration exceeds 30%"
          description: "Asset {{ $labels.asset_pair }} concentration: {{ $value | humanizePercentage }}"

      # Correlation warning
      - alert: HighPortfolioCorrelation
        expr: ffe_portfolio_correlation_average > 0.7
        for: 5m
        labels:
          severity: info
          component: risk_management
        annotations:
          summary: "Average portfolio correlation high"
          description: "Average correlation between positions: {{ $value }} (threshold: 0.7)"
