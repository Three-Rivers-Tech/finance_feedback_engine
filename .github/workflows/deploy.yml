name: Deploy to Environments

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - staging
          - production

jobs:
  # ===========================================================================
  # Deploy to Staging (Automatic on main push)
  # ===========================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.environment == 'staging'
    environment:
      name: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/finance-feedback-engine || exit 1
            echo "üì• Pulling latest changes..."
            git pull origin main
            echo "üîÑ Restarting services..."
            ./scripts/deploy.sh staging restart
            echo "‚úÖ Staging deployment complete"

      - name: Health check
        run: |
          echo "‚è≥ Waiting for services to stabilize..."
          sleep 30
          echo "üè• Performing health check..."
          curl -f http://${{ secrets.STAGING_HOST }}:8000/health || exit 1
          echo "‚úÖ Health check passed"

      - name: Deployment summary
        run: |
          echo "üöÄ Staging deployment successful!"
          echo "Environment: staging"
          echo "Host: ${{ secrets.STAGING_HOST }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

  # ===========================================================================
  # Deploy to Production (Manual approval required)
  # ===========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production'
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create pre-deployment backup
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/finance-feedback-engine || exit 1
            echo "üíæ Creating backup..."
            ./scripts/backup.sh
            echo "‚úÖ Backup created"

      - name: Deploy to production server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/finance-feedback-engine || exit 1
            echo "üì• Pulling latest changes..."
            git pull origin main
            echo "üèóÔ∏è  Building images..."
            ./scripts/build.sh production
            echo "üîÑ Restarting services..."
            ./scripts/deploy.sh production restart
            echo "‚úÖ Production deployment complete"

      - name: Health check
        run: |
          echo "‚è≥ Waiting for services to stabilize..."
          sleep 30
          echo "üè• Performing health check..."
          curl -f http://${{ secrets.PROD_HOST }}:8000/health || exit 1
          echo "‚úÖ Health check passed"

      - name: Deployment summary
        run: |
          echo "üöÄ Production deployment successful!"
          echo "Environment: production"
          echo "Host: ${{ secrets.PROD_HOST }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: Create deployment tag
        if: success()
        run: |
          TAG_NAME="deploy-prod-$(date +%Y%m%d-%H%M%S)"
          git tag $TAG_NAME
          git push origin $TAG_NAME || true
          echo "üìå Created deployment tag: $TAG_NAME"
