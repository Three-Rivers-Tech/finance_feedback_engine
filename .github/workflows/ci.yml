name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.13'

jobs:
  # =============================================================================
  # Pre-commit Checks (aligned with local development)
  # =============================================================================
  pre-commit:
    name: Code Quality (Pre-commit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Cache pre-commit hooks
        uses: actions/cache@v3
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-

      - name: Install dependencies for hooks
        run: pip install -e ".[dev]"

      - name: Run pre-commit hooks
        run: |
          # Run all hooks except pytest (which we run separately with proper env setup)
          SKIP=pytest-fast pre-commit run --all-files --show-diff-on-failure

  # =============================================================================
  # Tests with Coverage
  # =============================================================================
  test:
    name: Tests & Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Cache pytest
        uses: actions/cache@v3
        with:
          path: .pytest_cache
          key: pytest-${{ runner.os }}-${{ hashFiles('tests/**/*.py') }}
          restore-keys: |
            pytest-${{ runner.os }}-

      - name: Run tests with coverage
        run: |
          pytest -m "not external_service and not slow" \
            --cov=finance_feedback_engine \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=70 \
            -v

      - name: Generate coverage summary
        if: always()
        run: |
          echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f htmlcov/index.html ]; then
            echo "üìä Coverage report generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            # Extract coverage percentage (portable, no GNU grep dependency)
            COVERAGE=$(python3 << 'PYEOF'
          import re
          from pathlib import Path
          try:
              text = Path('htmlcov/index.html').read_text(encoding='utf-8', errors='ignore')
              match = re.search(r'pc_cov">(\d+)', text)
              print(match.group(1) if match else 'N/A')
          except Exception:
              print('N/A')
          PYEOF
          )
            echo "**Coverage:** ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            htmlcov/
            coverage.xml
          retention-days: 30

      - name: Upload to Codecov
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage.xml
          fail_ci_if_error: false  # Don't fail if Codecov is down
          verbose: true

  # =============================================================================
  # Security Scan (Essential checks only)
  # =============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install bandit[toml]

      - name: Run Bandit security scan
        run: |
          bandit -c pyproject.toml -r finance_feedback_engine/ -f screen
          bandit -c pyproject.toml -r finance_feedback_engine/ -f json -o bandit-report.json

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: bandit-report.json
          retention-days: 30

  # =============================================================================
  # CI Status Check (for branch protection)
  # =============================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [pre-commit, test, security]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "Pre-commit: ${{ needs.pre-commit.result }}"
          echo "Tests: ${{ needs.test.result }}"
          echo "Security: ${{ needs.security.result }}"

          if [ "${{ needs.pre-commit.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ]; then
            echo "‚ùå CI checks failed"
            exit 1
          fi

          echo "‚úÖ All CI checks passed"
