name: Staging Environment Tests

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.13'
  COMPOSE_FILE: docker-compose.test.yml

jobs:
  # =============================================================================
  # Docker Compose Build & Health Checks
  # =============================================================================
  staging-build:
    name: Build Staging Environment
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-staging-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-staging-

      - name: Create .env.test file
        run: |
          cp .env.test .env
          echo "Environment file prepared for CI"

      - name: Build Docker images
        run: |
          docker compose -f ${{ env.COMPOSE_FILE }} build --parallel
        env:
          DOCKER_BUILDKIT: 1
          COMPOSE_DOCKER_CLI_BUILD: 1

      - name: Start services
        run: |
          docker compose -f ${{ env.COMPOSE_FILE }} up -d
          echo "Services started, waiting for health checks..."

      - name: Wait for core services to be healthy
        uses: isbang/compose-action@v1.5.1
        with:
          compose-file: ${{ env.COMPOSE_FILE }}
          down-flags: "--volumes"
        continue-on-error: true

      - name: Manual health check fallback
        run: |
          echo "Checking service health status..."
          max_attempts=60
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            # Check critical services (redis, backend, frontend)
            redis_healthy=$(docker compose -f ${{ env.COMPOSE_FILE }} ps redis | grep -c "healthy" || echo "0")
            backend_healthy=$(docker compose -f ${{ env.COMPOSE_FILE }} ps backend | grep -c "healthy" || echo "0")
            frontend_healthy=$(docker compose -f ${{ env.COMPOSE_FILE }} ps frontend | grep -c "healthy" || echo "0")
            
            if [ "$redis_healthy" -gt 0 ] && [ "$backend_healthy" -gt 0 ] && [ "$frontend_healthy" -gt 0 ]; then
              echo "‚úÖ All critical services are healthy"
              break
            fi
            
            attempt=$((attempt + 1))
            echo "Waiting for services... ($attempt/$max_attempts)"
            sleep 5
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "‚ùå Services failed to become healthy"
            docker compose -f ${{ env.COMPOSE_FILE }} ps
            exit 1
          fi

      - name: Check optional services status
        continue-on-error: true
        run: |
          echo "üìä Optional services status:"
          docker compose -f ${{ env.COMPOSE_FILE }} ps ollama || echo "Ollama not running (optional)"
          docker compose -f ${{ env.COMPOSE_FILE }} ps prometheus || echo "Prometheus not running (optional)"

      - name: Verify all services are running
        run: |
          docker compose -f ${{ env.COMPOSE_FILE }} ps
          echo "‚úÖ All services started successfully"

      - name: Check service health endpoints
        run: |
          # Backend health check
          curl -f http://localhost:8000/health || {
            echo "‚ùå Backend health check failed"
            exit 1
          }
          echo "‚úÖ Backend health check passed"

          # Frontend accessibility check
          curl -f http://localhost:80/ || {
            echo "‚ùå Frontend accessibility check failed"
            exit 1
          }
          echo "‚úÖ Frontend accessibility check passed"

          # Prometheus health check
          curl -f http://localhost:9090/-/healthy || {
            echo "‚ùå Prometheus health check failed"
            exit 1
          }
          echo "‚úÖ Prometheus health check passed"

          # Redis health check
          docker compose -f ${{ env.COMPOSE_FILE }} exec -T redis redis-cli ping || {
            echo "‚ùå Redis health check failed"
            exit 1
          }
          echo "‚úÖ Redis health check passed"

      - name: Run integration tests in container
        id: integration-tests
        run: |
          docker compose -f ${{ env.COMPOSE_FILE }} exec -T backend pytest \
            -m "not external_service and not slow" \
            --cov=finance_feedback_engine \
            --cov-report=xml:/app/coverage.xml \
            --cov-report=term-missing \
            --cov-fail-under=70 \
            -v \
            --tb=short

      - name: Extract coverage report
        if: always()
        run: |
          # Check if container exists and file exists
          if docker ps -a --format '{{.Names}}' | grep -q '^ffe-backend-test$'; then
            echo "Container found, checking for coverage.xml..."
            if docker exec ffe-backend-test test -f /app/coverage.xml 2>/dev/null; then
              echo "Coverage file found, extracting..."
              docker cp ffe-backend-test:/app/coverage.xml ./coverage.xml
              echo "‚úÖ Coverage report extracted"
            else
              echo "‚ö†Ô∏è  No coverage.xml found in container"
              echo '<?xml version="1.0" ?><coverage version="7.0" />' > ./coverage.xml
            fi
          else
            echo "‚ö†Ô∏è  Container ffe-backend-test not found"
            echo '<?xml version="1.0" ?><coverage version="7.0" />' > ./coverage.xml
          fi

      - name: Run linting in container
        continue-on-error: true
        run: |
          docker compose -f ${{ env.COMPOSE_FILE }} exec -T backend bash -c "
            black --check finance_feedback_engine/ || echo 'Black formatting check failed'
            flake8 finance_feedback_engine/ --max-line-length=120 --extend-ignore=E203,W503 || echo 'Flake8 check failed'
            isort --check-only finance_feedback_engine/ || echo 'Import sorting check failed'
          "

      - name: Run security scan in container
        id: security-scan
        continue-on-error: true
        run: |
          set +e
          docker compose -f ${{ env.COMPOSE_FILE }} exec -T backend bash -c "
            pip install bandit[toml] && \
            bandit -c pyproject.toml -r finance_feedback_engine/ -f json -o /app/bandit-report.json
          "
          BANDIT_EXIT=$?
          echo "bandit_exit_code=$BANDIT_EXIT" >> $GITHUB_OUTPUT
          # Exit 0 = no issues, Exit 1 = findings detected (expected), Exit >1 = error
          if [ $BANDIT_EXIT -gt 1 ]; then
            echo "‚ùå Bandit scan failed with error"
            exit 1
          fi
          echo "Bandit scan completed (exit code: $BANDIT_EXIT)"
          exit 0

      - name: Extract security report
        if: always()
        run: |
          if docker ps -a --format '{{.Names}}' | grep -q '^ffe-backend-test$'; then
            if docker exec ffe-backend-test test -f /app/bandit-report.json 2>/dev/null; then
              docker cp ffe-backend-test:/app/bandit-report.json ./bandit-report.json
              echo "‚úÖ Security report extracted"
            else
              echo "‚ö†Ô∏è  No bandit-report.json found"
              echo '{"results": [], "metrics": {}}' > ./bandit-report.json
            fi
          else
            echo "‚ö†Ô∏è  Container not found"
            echo '{"results": [], "metrics": {}}' > ./bandit-report.json
          fi

      - name: Process security findings
        if: always()
        run: |
          BANDIT_EXIT="${{ steps.security-scan.outputs.bandit_exit_code }}"

          if [ "$BANDIT_EXIT" = "1" ]; then
            # Bandit found security issues (informational for staging, non-blocking)
            ISSUE_COUNT=$(jq '.results | length' ./bandit-report.json || echo "0")
            echo "::warning::Bandit security scan found $ISSUE_COUNT issue(s). Review bandit-report.json artifact for details. This is informational only for staging pipeline."

            # Add to job summary for visibility
            {
              echo "## ‚ö†Ô∏è Security Scan Results"
              echo ""
              echo "Bandit detected **$ISSUE_COUNT** security issue(s)."
              echo ""
              echo "### Next Steps:"
              echo "- Review the **staging-security-report** artifact (bandit-report.json)"
              echo "- Address high-severity findings before promoting to production"
              echo "- This report is for informational purposes in staging"
            } >> $GITHUB_STEP_SUMMARY
          elif [ "$BANDIT_EXIT" = "0" ]; then
            echo "‚úÖ Bandit security scan completed with no findings"
            echo "## ‚úÖ Security Scan Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No security issues detected." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è  Bandit exit code: $BANDIT_EXIT (unexpected value)"
          fi

      - name: Test API endpoints
        run: |
          # Test analyze endpoint (should work with mock platform)
          curl -X POST http://localhost:8000/analyze \
            -H "Content-Type: application/json" \
            -d '{"asset_pair": "BTCUSD", "provider": "ensemble"}' \
            -w "\nHTTP Status: %{http_code}\n" || echo "Analyze endpoint test completed"

          # Test health endpoint
          curl -f http://localhost:8000/health || {
            echo "‚ùå Health endpoint failed"
            exit 1
          }
          echo "‚úÖ Health endpoint passed"

      - name: Collect service logs
        if: always()
        run: |
          mkdir -p logs
          docker compose -f ${{ env.COMPOSE_FILE }} logs --no-color > logs/all-services.log
          docker compose -f ${{ env.COMPOSE_FILE }} logs backend --no-color > logs/backend.log
          docker compose -f ${{ env.COMPOSE_FILE }} logs frontend --no-color > logs/frontend.log
          docker compose -f ${{ env.COMPOSE_FILE }} logs ollama --no-color > logs/ollama.log
          docker compose -f ${{ env.COMPOSE_FILE }} logs prometheus --no-color > logs/prometheus.log
          docker compose -f ${{ env.COMPOSE_FILE }} logs redis --no-color > logs/redis.log

      - name: Upload service logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: staging-service-logs
          path: logs/
          retention-days: 14

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: staging-coverage
          path: |
            coverage.xml
          retention-days: 30

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: staging-security-report
          path: bandit-report.json
          retention-days: 30

      - name: Upload to Codecov
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage.xml
          flags: staging
          fail_ci_if_error: false
          verbose: true

      - name: Check test results
        if: always()
        run: |
          if [ "${{ steps.integration-tests.outcome }}" != "success" ]; then
            echo "‚ùå Integration tests failed"
            docker compose -f ${{ env.COMPOSE_FILE }} logs backend
            exit 1
          fi
          echo "‚úÖ All tests passed"

      - name: Cleanup
        if: always()
        run: |
          docker compose -f ${{ env.COMPOSE_FILE }} down -v
          docker system prune -f

  # =============================================================================
  # Frontend Build Validation
  # =============================================================================
  frontend-build:
    name: Validate Frontend Build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: frontend
        run: npm run test

      - name: Run type checking
        working-directory: frontend
        run: npm run type-check

      - name: Build frontend
        working-directory: frontend
        env:
          VITE_API_BASE_URL: /api
          VITE_GRAFANA_URL: /grafana
          VITE_POLLING_INTERVAL_CRITICAL: 3000
          VITE_POLLING_INTERVAL_MEDIUM: 5000
        run: npm run build

      - name: Check build output
        run: |
          if [ ! -d "frontend/dist" ]; then
            echo "‚ùå Frontend build output not found"
            exit 1
          fi
          echo "‚úÖ Frontend build successful"
          ls -lah frontend/dist/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/
          retention-days: 7

  # =============================================================================
  # Staging Success Summary
  # =============================================================================
  staging-success:
    name: Staging Environment Success
    runs-on: ubuntu-latest
    needs: [staging-build, frontend-build]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          echo "## Staging Environment Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.staging-build.result }}" == "success" ]; then
            echo "‚úÖ **Staging Build:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Staging Build:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.frontend-build.result }}" == "success" ]; then
            echo "‚úÖ **Frontend Build:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Frontend Build:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.staging-build.result }}" != "success" ] || \
             [ "${{ needs.frontend-build.result }}" != "success" ]; then
            echo "‚ùå Staging environment checks failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "‚úÖ **All staging checks passed!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The application is ready for deployment." >> $GITHUB_STEP_SUMMARY
